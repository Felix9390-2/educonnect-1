{% extends "base.html" %}

{% block title %}Messages - School Social Platform{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 fw-bold text-primary">
                <i class="fas fa-envelope me-2"></i>Direct Messages
            </h1>
            <div class="input-group" style="width: 300px;">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="messageSearch" placeholder="Search people...">
            </div>
        </div>
        
        <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle me-2"></i>
            Click on any student to start or continue a conversation with them.
        </div>
        
        {% if students %}
            <div class="row">
                {% for student_data in students %}
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100 {% if student_data.has_conversation %}border-primary{% endif %}">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-2">
                                <div class="avatar-circle me-3">
                                    {{ student_data.user.full_name[0].upper() }}
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0">
                                        <a href="{{ url_for('view_conversation', username=student_data.user.username) }}" 
                                           class="text-decoration-none">
                                            {{ student_data.user.full_name }}
                                        </a>
                                        {% if student_data.user.is_admin %}
                                            <span class="badge bg-danger badge-sm ms-1">ADMIN</span>
                                        {% elif student_data.user.is_prefect and student_data.user.house %}
                                            {% if student_data.user.house == 'St. Patrick' %}
                                                <span class="badge bg-success badge-sm ms-1">ST. PATRICK</span>
                                            {% elif student_data.user.house == 'St. Raphael' %}
                                                <span class="badge bg-warning text-dark badge-sm ms-1">ST. RAPHAEL</span>
                                            {% elif student_data.user.house == 'St. Nicolas' %}
                                                <span class="badge badge-sm ms-1" style="background-color: #ff6b35; color: white;">ST. NICOLAS</span>
                                            {% elif student_data.user.house == 'St. Michael' %}
                                                <span class="badge bg-info badge-sm ms-1">ST. MICHAEL</span>
                                            {% endif %}
                                        {% elif student_data.user.is_prefect %}
                                            <span class="badge bg-warning text-dark badge-sm ms-1">PREFECT</span>
                                        {% endif %}
                                    </h6>
                                    <small class="text-muted">
                                        @{{ student_data.user.username }}
                                        {% if student_data.user.grade_level %}
                                            • Grade {{ student_data.user.grade_level }}
                                        {% endif %}
                                    </small>
                                </div>
                                {% if student_data.unread_count > 0 %}
                                    <span class="badge bg-danger">{{ student_data.unread_count }}</span>
                                {% endif %}
                            </div>
                            
                            {% if student_data.last_message %}
                                <div class="bg-light rounded p-2 mt-2">
                                    <small class="text-muted d-block">
                                        <strong>
                                            {% if student_data.last_message.sender_id == session.user_id %}
                                                You:
                                            {% else %}
                                                {{ student_data.user.full_name.split()[0] }}:
                                            {% endif %}
                                        </strong>
                                        {{ student_data.last_message.content[:40] }}{% if student_data.last_message.content|length > 40 %}...{% endif %}
                                    </small>
                                    <small class="text-muted">
                                        {{ student_data.last_message.date_sent.strftime('%b %d, %Y at %I:%M %p') }}
                                    </small>
                                </div>
                            {% else %}
                                <div class="text-center mt-2">
                                    <small class="text-muted">No conversation yet</small>
                                </div>
                            {% endif %}
                            
                            <div class="d-grid mt-3">
                                <a href="{{ url_for('view_conversation', username=student_data.user.username) }}" 
                                   class="btn {% if student_data.has_conversation %}btn-primary{% else %}btn-outline-primary{% endif %} btn-sm">
                                    <i class="fas fa-comment me-1"></i>
                                    {% if student_data.has_conversation %}Continue Chat{% else %}Start Chat{% endif %}
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-user-slash fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">No other students found</h4>
                    <p class="text-muted">There are currently no other students to message.</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Real-time messages list with search functionality
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('messageSearch');
    const conversationsContainer = document.querySelector('.row');
    let allConversations = [];
    let searchTerm = '';
    
    // Original search functionality
    function filterConversations() {
        const term = searchTerm.toLowerCase().trim();
        
        document.querySelectorAll('.col-md-6.col-lg-4.mb-3').forEach(function(card) {
            const fullName = card.querySelector('h6 a').textContent.toLowerCase();
            const username = card.querySelector('small.text-muted').textContent.toLowerCase();
            
            const matches = fullName.includes(term) || username.includes(term);
            card.style.display = matches ? '' : 'none';
        });
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            searchTerm = this.value;
            filterConversations();
        });
    }
    
    // Helper function to get badge HTML for user roles
    function getUserBadges(user) {
        let badges = '';
        if (user.is_admin) {
            badges += '<span class="badge bg-danger badge-sm ms-1">ADMIN</span>';
        } else if (user.is_teacher) {
            badges += '<span class="badge bg-success badge-sm ms-1">TEACHER</span>';
        } else if (user.is_prefect && user.house) {
            if (user.house === 'St. Patrick') {
                badges += '<span class="badge bg-success badge-sm ms-1">ST. PATRICK</span>';
            } else if (user.house === 'St. Raphael') {
                badges += '<span class="badge bg-warning text-dark badge-sm ms-1">ST. RAPHAEL</span>';
            } else if (user.house === 'St. Nicolas') {
                badges += '<span class="badge badge-sm ms-1" style="background-color: #ff6b35; color: white;">ST. NICOLAS</span>';
            } else if (user.house === 'St. Michael') {
                badges += '<span class="badge bg-info badge-sm ms-1">ST. MICHAEL</span>';
            }
        } else if (user.is_prefect) {
            badges += '<span class="badge bg-warning text-dark badge-sm ms-1">PREFECT</span>';
        }
        return badges;
    }
    
    // Helper function to truncate message content
    function truncateMessage(content, maxLength = 40) {
        if (content.length > maxLength) {
            return content.substring(0, maxLength) + '...';
        }
        return content;
    }
    
    // Function to create conversation card HTML
    function createConversationCard(conversationData) {
        const borderClass = conversationData.has_conversation ? 'border-primary' : '';
        const buttonClass = conversationData.has_conversation ? 'btn-primary' : 'btn-outline-primary';
        const buttonText = conversationData.has_conversation ? 'Continue Chat' : 'Start Chat';
        
        let lastMessageHtml = '';
        if (conversationData.last_message) {
            const senderName = conversationData.last_message.sender_id === {{ session.user_id }} ? 'You' : conversationData.full_name.split(' ')[0];
            lastMessageHtml = `
                <div class="bg-light rounded p-2 mt-2">
                    <small class="text-muted d-block">
                        <strong>${senderName}:</strong>
                        ${truncateMessage(conversationData.last_message.content)}
                    </small>
                    <small class="text-muted">
                        ${conversationData.last_message.formatted_time}
                    </small>
                </div>
            `;
        } else {
            lastMessageHtml = `
                <div class="text-center mt-2">
                    <small class="text-muted">No conversation yet</small>
                </div>
            `;
        }
        
        const unreadBadge = conversationData.unread_count > 0 ? 
            `<span class="badge bg-danger">${conversationData.unread_count}</span>` : '';
        
        return `
            <div class="col-md-6 col-lg-4 mb-3" data-user-id="${conversationData.user_id}">
                <div class="card h-100 ${borderClass}">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <div class="avatar-circle me-3">
                                ${conversationData.initial}
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-0">
                                    <a href="/message/${conversationData.username}" class="text-decoration-none">
                                        ${conversationData.full_name}
                                    </a>
                                    ${getUserBadges(conversationData)}
                                </h6>
                                <small class="text-muted">
                                    @${conversationData.username}
                                    ${conversationData.grade_level ? '• Grade ' + conversationData.grade_level : ''}
                                </small>
                            </div>
                            ${unreadBadge}
                        </div>
                        
                        ${lastMessageHtml}
                        
                        <div class="d-grid mt-3">
                            <a href="/message/${conversationData.username}" class="btn ${buttonClass} btn-sm">
                                <i class="fas fa-comment me-1"></i>
                                ${buttonText}
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Function to update conversations list
    function updateConversationsList(conversations) {
        allConversations = conversations;
        
        // Clear current conversations
        conversationsContainer.innerHTML = '';
        
        // Add updated conversations
        conversations.forEach(conversation => {
            conversationsContainer.innerHTML += createConversationCard(conversation);
        });
        
        // Apply current search filter
        filterConversations();
    }
    
    // Function to fetch and update conversations
    function fetchConversations() {
        fetch('/api/conversations/list')
            .then(response => response.json())
            .then(data => {
                if (data.conversations) {
                    updateConversationsList(data.conversations);
                }
            })
            .catch(error => console.error('Error fetching conversations:', error));
    }
    
    // Poll for updates every 4 seconds (slightly different from global notifications to stagger requests)
    setInterval(fetchConversations, 4000);
    
    // Also fetch immediately to get the latest data
    fetchConversations();
});
</script>
{% endblock %}